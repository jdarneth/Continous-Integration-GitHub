name: Close release create artifact

on:
  issues:
    types: [closed]

jobs:
  close-release:
      name: "Close release create artifact"
      runs-on: ubuntu-latest
      if: startsWith(github.event.issue.title, 'Release') && contains(github.event.issue.labels.*.name, 'release')
      
      permissions:
        contents: write
      
      steps:
      
        - name: Extract release version
          shell: bash
          run: |
            TITLE="${{ github.event.issue.title }}"
            VERSION=${TITLE#Release }
            echo "##[set-output name=version;]$(echo $VERSION)"
          id: extract_release_version
      
        - uses: actions/checkout@v3
          with: 
            ref: "release/${{ steps.extract_release_version.outputs.version }}"
            
        - name: Run chmod to make gradlew executable
          run: chmod +x ./gradlew

        - name: Build with Gradle
          uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
          with:
            arguments: build
        
        - name: upload artifact
          uses: actions/upload-artifact@v3
          with: 
            name: BLACKJACK-${{ steps.extract_branch.outputs.branch }}
            path: artifacts/
        
        - name: Initialize mandatory git config
          run: |
            git config user.name "GitHub Web Flow"
            git config user.email "noreply@github.com"

        - name: Push new branch
          run: |
            git add .
            git commit -m "create artifact"
            git push origin release/${{ steps.extract_release_version.outputs.version }}
        
        - name: create release
          uses: ncipollo/release-action@v1
          with:
            tag: "release/${{ steps.extract_release_version.outputs.version }}"
            artifacts: "artifacts/BLACKJACK-${{ steps.extract_release_version.outputs.version }}.zip"
            
